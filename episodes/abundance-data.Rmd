---
title: "Abundance Data"
teaching: 10
exercises: 2
editor_options: 
  markdown: 
    wrap: 50
---



::: questions 

- How is organismal abundance data typically stored?
- How is the species abundance distribution used to compare abundance data from differing systems?
- How do we use summary statistics - including Hill numbers - to quantitatively compare species abundance distributions?

:::

::::::::::::::::::::::::::::::::::::: objectives

After following this episode, participants should be able to...


1. Import and examine organismal abundance data from .csv files
1. Clean taxonomic names
2. Manipulate abundance data into different formats
2. Generate species abundance distribution plots from abundance data
3. Summarize species abundance data using Hill numbers
4. Interpret how different Hill numbers correspond to different patterns in species diversity




::::::::::::::::::::::::::::::::::::::::::::::::


# Setup

For this episode, we'll be working with a couple of specialized packages for biological data. 

```{r load packagse}

library(dplyr)
library(taxize)
library(hillR)
library(vegan)
library(tidyr)

```

# Data import and cleaning

## Loading data

We'll be working with ecological species abundance data stored in `.csv` files. For help working with other storage formats, [the Carpentries' Ecological Data lesson materials on databases](https://datacarpentry.org/R-ecology-lesson/05-r-and-databases.html) are a great place to start!

Let's load the data:



```{r load data}
abundances <- read.csv("http://bit.ly/3INNA9V")

```

And look at what we've got:


```{r head}

head(abundances)

```

`abundances` is a data frame with columns for `island`, `site`, and `GenSp`. These data are in a common format in which each row represents a single individual observed. 

## Cleaning taxonomic names

The first thing we'll want to do is check for human error wherever we can, in this case in the form of typos in data entry.

The `taxize` R package can help identify and resolve simple typos in taxonomic names. 

```{r taxize}

species_list <- unique(abundances$GenSp)

name_resolve <- gnr_resolve(species_list, best_match_only = TRUE, 
                            canonical = TRUE) # returns only name, not authority

```


```{r explore taxise outcomes}
head(name_resolve)
```

```{r find mismatches}


mismatches <- name_resolve[ name_resolve$matched_name2 != name_resolve$user_supplied_name, ]

mismatches[, c("user_supplied_name", "matched_name2")]

```

Four of these are just typos. But `Agrotis chersotoides` in our data is resolved only to Agrotis. What's up there?

::: discussion

Agrotis taxonomic resolution

:::


```{r fix agrotis}

name_resolve$matched_name2[name_resolve$user_supplied_name == "Agrotis chersotoides"] <- "Peridroma chersotoides"

```



Now we need to add the newly-resolved names to our `abundnaces` data:


```{r join abundances and names}
abundances <- left_join(abundances, name_resolve, by = c("GenSp" = "user_supplied_name"))

abundances$final_name <- abundances$matched_name2

```


## Wrangling abundance data

The data we have have one record per individual, but we'd like to have the _total_ number of individuals of each species in our data. 


```{r compute species totals}

abundance_tallies <- group_by(abundances, site, island, final_name)
abundance_tallies <- summarize(abundance_tallies, abundance = n())

head(abundance_tallies)

```

Write out the tallied data for later use:

```{r save abundance tallies, eval=FALSE}
write.csv(abundance_tallies, "abundance_tallies.csv", row.names = FALSE)
```


## Site-by-species matrix

Often we'll want to work with a _site by species matrix_, which has sites as rows and species as columns. We can get there using the `pivot_wider` function from the package `tidyr`:

```{r site by species}

abundance_wide <- pivot_wider(abundance_tallies, id_cols = site,
                              names_from = final_name,
                              values_from = abundance, 
                              values_fill = 0)

head(abundance_wide)

```

We'll want this data to have _row names_ based on the sites, so we'll need some more steps:

```{r}

abundance_wide <- as.data.frame(abundance_wide)

row.names(abundance_wide) <- abundance_wide$site

abundance_wide <- abundance_wide[, -1]

head(abundance_wide)

```

<!-- ```{r or base r} -->
<!-- x <- aggregate(abundances[, 'final_name', drop = FALSE], abundances[, c('final_name', 'site')],  -->
<!--                length) -->

<!-- head(x) #is identical -->
<!-- ``` -->

# Visualization via the species abundance distribution

## Separating the islands

```{r}

kauai_abund <- abundance_tallies[ abundance_tallies$island == "Kauai", ]
maui_abund <- abundance_tallies[ abundance_tallies$island == "Maui", ]
hawaiiisland_abund <- abundance_tallies[ abundance_tallies$island == "HawaiiIsland", ]

```

## Plotting SADs

```{r hawaii sad plot}

plot(sort(hawaiiisland_abund$abundance, TRUE))

```


::: challenge

Plot the rank-abundance distributions for the remaining islands.

:::


::: solution


```{r kauai sad plot}

plot(sort(kauai_abund$abundance, TRUE))

```


```{r maui sad plot}
plot(sort(maui_abund$abundance, TRUE))

```

:::



# Summary statistics

## Diversity indices

The `vegan` package is a widely-used toolset for calculating diversity indices on ecological abundance data. 

### Species richness


```{r richness}

richness <- specnumber(abundance_wide)

richness
```

### Shannon's index

```{r shannon on hawaii}

shannon <- diversity(abundance_wide, index = "shannon")

shannon
```


```{r exp shannon}

exp_shannon <- exp(shannon)


exp_shannon
```

### Simpson's evenness


```{r simpson on hawaii}

simpson <- diversity(abundance_wide, index = "simpson")
simpson

```

::: challenge

Compute the *inverse* Simpson index.

(Hint: use `?diversity` to get more information about the `diversity` function).

:::


::: solution

```{r invsimpson }

invsimpson <- diversity(abundance_wide, index = "invsimpson")

invsimpson
```

:::


### Combining values into a dataframe

```{r consolidate diversity metrics}

diversity_metrics <- rbind(exp_shannon, 
                           invsimpson,
                           richness)

diversity_metrics
```

## Hill numbers

::: discussion

Hill numbers are a unifying framework.

:::

### Calculating Hill numbers

The `hillR` package allows us to calculate Hill numbers in much the same way we calculate diversity indices in `vegan`.

```{r hill 0}

hill_0 <- hill_taxa(abundance_wide, q = 0 )

hill_0

```

```{r hill 1}

hill_1 <- hill_taxa(abundance_wide, q = 1)

hill_1

```


::: challenge

Calculate the hill numbers for q = 2.

:::

::: solution

```{r hill 2}

hill_2 <- hill_taxa(abundance_wide, q = 2)

hill_2

```

:::


### Combining and plotting Hill numbers

```{r combining hill numbers}

hill_numbers <- rbind(hill_0, hill_1, hill_2)
hill_numbers
```

::: discussion

Compare the values for the Hill numbers to the values we generated earlier for richness,  Shannon's index, and the inverse Simpson.

The following may help:

```{r show dis}

diversity_metrics

```


```{r show hills}

hill_numbers

```


:::


## Relating Hill numbers to patterns in diversity

Let's revisit the SAD plots we generated before, and think about these in terms of Hill numbers. 

```{r sad again plots}

par(mfrow = c(3,1))
plot(sort(hawaiiisland_abund$abundance, TRUE))
plot(sort(kauai_abund$abundance, TRUE))
plot(sort(maui_abund$abundance, TRUE))


```


```{r hill again}
hill_numbers

```



# Recap

::: keypoints

- Organismal abundance data are a fundamental data type for population and community ecology.
- The `taxise` package can help with data cleaning, but quality checks are often ultimately dataset-specific. 
- The species abundance distribution (SAD) summarizes site-specific abundance information to facilitate cross-site or over-time comparisons.
- We can quantify the shape of the SAD using *summary statistics*. Specifically, *Hill numbers* provide a unified framework for describing the diversity of a system.

:::
    
