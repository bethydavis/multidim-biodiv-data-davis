---
title: "Abundance Data"
teaching: 10
exercises: 2
---

:::::::::::::::::::::::::::::::::::::: questions 

- How is organismal abundance data typically stored?
- How is the species abundance distribution used to compare abundance data from differing systems?
- How do we use summary statistics - including Hill numbers - to quantitatively compare species abundance distributions?

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

After following this episode, participants should be able to...


1. Import and examine organismal abundance data from .csv files
1. Clean taxonomic names
2. Manipulate abundance data into different formats
2. Generate species abundance distribution plots from abundance data
3. Summarize species abundance data using Hill numbers
4. Interpret how different Hill numbers correspond to different patterns in species diversity




::::::::::::::::::::::::::::::::::::::::::::::::


# Setup

For this episode, we'll be working with a couple of specialized packages for biological data. 

```{r load packagse}

library(dplyr)
library(taxize)
library(hillR)

```

# Data import and cleaning

## Loading data

We'll be working with ecological species abundance data stored in `.csv` files. For help working with other storage formats, [the Carpentries' Ecological Data lesson materials on databases](https://datacarpentry.org/R-ecology-lesson/05-r-and-databases.html) are a great place to start!

Let's load the data:

::: instructor
Fix the data path.
:::


```{r load data}
abundances <- read.csv("https://github.com/role-model/multidim-biodiv-data/raw/main/episodes/data/long_abundances.csv")

```

And look at what we've got:


```{r head}

head(abundances)

```

`abundances` is a data frame with columns for `island`, `site`, and `GenSp`. These data are in a common format in which each row represents a single individual observed. 

## Cleaning taxonomic names

The first thing we'll want to do is check for human error wherever we can, in this case in the form of typos in data entry.

The `taxize` R package can help identify and resolve simple typos in taxonomic names. 

```{r taxize}

species_list <- unique(abundances$GenSp)

wtf <- gnr_resolve(species_list, best_match_only = TRUE, 
                           canonical = TRUE) # returns only name, not authority


# one clean/QC check is to remove entries with score < 0.6
```

Here is what I would do, naively:

```{r}
library(dplyr)

# don't need if using `best_match_only = TRUE` in `gnr_resolve`
# best_scores <- wtf %>% group_by(user_supplied_name) %>%
#     mutate(rank_score = dplyr::row_number()) %>%
#     filter(rank_score == 1) %>%
#     select(user_supplied_name,
#            matched_name)

abundances <- left_join(abundances, wtf, by = c("GenSp" = "user_supplied_name"))

unique(abundances[which(abundances$GenSp != abundances$matched_name), 
                  c("GenSp", "matched_name2")])

abundances$final_name <- abundances$matched_name2
abundances$final_name[abundances$final_name == "Cirphis"] <- "Mythimna amblycasis" # This one I picked seems to be a synonym and this is the one that comes up on Wikipedia

```


## Wrangling abundance data

The data we have have one record per individual, but we'd like to have the _total_ number of individuals of each species in our data. 


```{r compute species totals}

abundance_tallies <- group_by(abundances, site, island, matched_name2)
abundance_tallies <- summarize(abundance_tallies, abundance = n())
abundance_tallies <- ungroup(abundance_tallies)

head(abundance_tallies)

```

```{r or base r}
x <- aggregate(abundances[, 'matched_name2', drop = FALSE], abundances[, c('matched_name2', 'site')], 
               length)

head(x) #is identical
```

# Visualization via the species abundance distribution

## Plotting SADs

# Summary statistics

## Diversity indices

## Hill numbers

## Relating Hill numbers to patterns in diversity



# Recap

::: keypoints

- Organismal abundance data are a fundamental data type for population and community ecology.
- The `taxise` package can help with data cleaning, but quality checks are often ultimately dataset-specific. 
- The species abundance distribution (SAD) summarizes site-specific abundance information to facilitate cross-site or over-time comparisons.
- We can quantify the shape of the SAD using *summary statistics*. Specifically, *Hill numbers* provide a unified framework for describing the diversity of a system.

:::
